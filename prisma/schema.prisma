generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(uuid())
  username              String   @unique
  passwordHash          String?
  githubId              String?  @unique
  githubUsername        String?
  requirePasswordChange Boolean  @default(true)
  passwordLoginEnabled  Boolean  @default(true)
  createdAt             DateTime @default(now())
}

model Provider {
  id              String   @id @default(uuid())
  name            String
  type            String
  accessKeyId     String
  secretAccessKey String
  endpoint        String?
  region          String?
  forcePathStyle  Boolean  @default(false)
  disableChunked  Boolean  @default(false)
  createdAt       DateTime @default(now())
  buckets         Bucket[]
}

model Bucket {
  id           String   @id @default(uuid())
  providerId   String
  name         String
  createdAt    DateTime @default(now())
  provider     Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, name])
}

enum TransferTaskStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED
}

model TransferTask {
  id            String             @id @default(uuid())
  status        TransferTaskStatus @default(QUEUED)
  progress      Int                @default(0)
  error         String?
  srcProviderId String
  srcBucket     String
  srcKey        String
  dstProviderId String
  dstBucket     String
  dstKey        String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([status, updatedAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

model AppConfig {
  key   String @id
  value String
}

model AuditLog {
  id           String   @id @default(uuid())
  action       String
  status       String   @default("SUCCESS")
  description  String
  userId       String
  username     String
  providerId   String?
  providerName String?
  bucket       String?
  ipAddress    String   @default("unknown")
  userAgent    String?
  metadata     String?
  createdAt    DateTime @default(now())

  @@index([createdAt(sort: Desc)])
  @@index([action])
  @@index([status])
  @@index([providerId])
}
